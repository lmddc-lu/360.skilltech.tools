--USE tour;

CREATE TABLE IF NOT EXISTS `user` (
    `id` INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    `email` VARCHAR(255) NOT NULL,
    `directory` CHAR(12) UNIQUE NOT NULL,
    `onboarding` TINYINT DEFAULT 1,
    `creation_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `modification_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);

CREATE TABLE IF NOT EXISTS `tour` (
    `id` INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    `title` VARCHAR(65),
    `filename` CHAR(10) UNIQUE NOT NULL,
    `user_id` INT NOT NULL,
    `description` TEXT(1023) DEFAULT NULL,
    `author` VARCHAR(255) DEFAULT NULL,
    `license` VARCHAR(16) DEFAULT NULL,
    `start_id` INT DEFAULT NULL,
    `thumb_id` VARCHAR(255) DEFAULT NULL,
    `password` VARCHAR(255) DEFAULT NULL,
    `share` BOOLEAN DEFAULT FALSE,
    `creation_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `modification_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user(id)
);

CREATE TABLE IF NOT EXISTS `spot` (
    `id` INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    `title` VARCHAR(65),
    `tour_id` INT NOT NULL,
    `lat` FLOAT DEFAULT NULL, 
    `lng` FLOAT DEFAULT NULL, 
    `creation_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `modification_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (tour_id) REFERENCES tour(id)
);

CREATE TABLE IF NOT EXISTS `spot_has_spot` (
    `id` INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    `spot1` INT,
    `spot2` INT,
    `spot1x` INT,
    `spot1y` INT,
    `spot2x` INT,
    `spot2y` INT,
    `spot1t` TINYINT NOT NULL DEFAULT 0,
    `spot2t` TINYINT NOT NULL DEFAULT 0,
    FOREIGN KEY (spot1) REFERENCES spot(id),
    FOREIGN KEY (spot2) REFERENCES spot(id)
);

CREATE TABLE IF NOT EXISTS `image` (
    `id` INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    `user_id` INT NOT NULL,
    `src_filename` VARCHAR(255) DEFAULT NULL,
    `filename` CHAR(10) NOT NULL,
    `filetype` CHAR(3) NOT NULL,
    `filesize` INT NOT NULL,
    `title` VARCHAR(127),
    `width` INT NOT NULL,
    `height` INT NOT NULL,
    `creation_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `modification_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES user(id)
);

CREATE TABLE IF NOT EXISTS `poi` (
    `id` INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    `icon` VARCHAR(10) DEFAULT NULL,
    `title` VARCHAR(65) DEFAULT NULL,
    `text` TEXT DEFAULT NULL,
    `image_id` INT DEFAULT NULL,
    `spot_id` INT NOT NULL,
    `x` INT NOT NULL DEFAULT 0,
    `y` INT NOT NULL DEFAULT 0,
    `layer` INT NOT NULL DEFAULT 0,
    `template` INT NOT NULL DEFAULT 0,
    `creation_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `modification_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (spot_id) REFERENCES spot(id),
    FOREIGN KEY (image_id) REFERENCES image(id)
);

CREATE TABLE IF NOT EXISTS `sky` (
    `id` INT PRIMARY KEY NOT NULL AUTO_INCREMENT,
    `image_id` INT DEFAULT NULL,
    `spot_id` INT NOT NULL,
    `layer` INT NOT NULL DEFAULT 0,
    `creation_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
    `modification_date` DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    FOREIGN KEY (spot_id) REFERENCES spot(id),
    FOREIGN KEY (image_id) REFERENCES image(id)
);

ALTER TABLE `tour` ADD `password` VARCHAR(255) DEFAULT NULL;
ALTER TABLE `tour` ADD `share` BOOLEAN NOT NULL DEFAULT FALSE;
